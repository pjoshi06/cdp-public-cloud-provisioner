# CDP Public Cloud: Hands On Labs Infrastructure Provisioner

Author: **Puneet Joshi**



## Overview:

Hands-on Labs play a crucial role in showcasing the capabilities of Cloudera Data Platform Public Cloud form factor to partners and customers. They offer a practical and immersive learning experience that goes beyond mere overview. Hands-on Labs facilitate participant engagement and allow them to explore and interact with different PaaS offerings of Cloudera Data Platform.


Infrastructure components are important and play a vital role in acheieving the goal of Hands-on Labs and to give a better experience to the participants.

**Hands On Labs Infrastructure Provisioner** is a container based solution which takes care of provisioning the required infrastaructure components without much manual efforts. It creates a **disposable** on-demand stack consists of CDP Environment, Keycloak Server & Users by executing a **single** command.


## Technology Stack:
**Hands On Labs Infrastructure Provisioner** employs a robust toolchain consisting of:


1.  Ansible
2.  Terraform
3.  Cloudera.cloud
4.  CDP-tf-quickstarts
5.  CDPY
6.  CDP CLI
7.  AWS CLI
8.  Shell Scripting

All the above tools are integrated with each other and packaged as a Dokcer Container for use.

## Prerequisites:
The ready to use container takes care of all the dependencies of required tools & does not require user to install or configure any of the above listed tools. 
For using this user should have:

1. Docker.
2. Programatic Access(CDP_ACCESS_KEY_ID & CDP_PRIVATE_KEY) of CDP Tenant
3. Programatic Access(AWS_ACCESS_KEY_ID & AWS_SECRET_ACCESS_KEY) of the AWS account with Administrator or Power User Role

## How To Use:
=== Step 1: Generate Keys
#### CDP:
* On the CDP Portal, click at the left bottom corner and click on Profile as shown below. 

image::images/profile.png[profile,180,200]

image::images/profile_1.png[profile1,290,220]

* Click on Generate Access Key as shown below. 

image::images/gen_access_key.png[access_key,900,200]

* Copy the values of Access Key ID and Private Key separately and keep it in a note. Or download the keys by pressing the Blue Button.

image::images/gen_access_key_1.png[access_key1,450,300]

#### AWS
1. Open the IAM console at https://console.aws.amazon.com/iam/.

2. On the navigation menu, choose Users.

3. Choose your IAM user name (not the check box).

4. Open the Security credentials tab, and then choose Create access key.

5. To see the new access key, choose Show. Your credentials resemble the following:
[.shell]
----
Access key ID: AKIAIOSFODNN7EXAMPLE

Secret access key: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY

----

To download the key pair, choose Download .csv file. Store the .csv file with keys in a secure location.

---

=== Step 2: AWS SSH Key Pair
1. Open the Amazon EC2 console at https://console.aws.amazon.com/ec2/.

2. In the navigation pane, under Network & Security, choose Key Pairs.

3. Choose Create key pair.

4. For Name, enter a descriptive name for the key pair. It canâ€™t include leading or trailing spaces.

5. For Key pair type, choose either RSA.

6. For Private key file format, choose the pem format.

7. To add a tag to the public key, choose Add tag, and enter the key and value for the tag. Repeat for each tag.

8. Choose Create key pair.

The private key file is automatically downloaded by your browser. The base file name is the name that you specified as the name of your key pair, and the file name extension is determined by the file format that you chose. Save the private key file in a safe place.

---
=== Step 3: Get the docker image.
The docker image is available at Docker Hub. Once the Docker is installed and ready to use pull the **cdp-public-cloud-hol-provisioner:1.1** image by executing below command.


[.shell]
----
docker pull pjoshi06/cdp-public-cloud-hol-provisioner:1.1

----

---

=== Step 4: Define Configuration Values For Stack:
This docker based provisioner requires values of mandatory parameters to provision the infrastructure. It reads the values of these parameters from a configuration file hosted on your local machine. This section walks you through all the steps which are required to create a configuration file. This is the most **important** part so please dont skip any
step of this section.

==== A): 
Create a folder inside your user home directory on your local machine by name **userconfig**. This folder will store all the configuration file and output generated in
further steps.
Mac Users:

[.shell]
----
mkdir -p /Users/puneetjoshi/userconfig

----
Windows Users:

[.shell]
----
C:\Users\Puneet Joshi\userconfig

----

==== B): 
Download the  **configuration/configfile** and place it inside the above created directory. Make sure you dont add any file extension to it. (.txt,.doc).

==== C): 
Start editing the **configfile** with the help of editor of your choice. **Don't add any quotes(single or double) in values and no 'new line' after the last entry in the file.** Refer to below table for defining
values of the parameters.

[%header,cols="1,1,1"]
|===
|Parameter
|Description
|Remarks

|KEYCLOAK_SERVER_NAME
|Name for Keycloak EC2 Instance
|No quotes
|AWS_ACCESS_KEY_ID
|Generated in AWS section of Step 1
|No quotes
|AWS_SECRET_ACCESS_KEY
|Generated in AWS section of Step 1
|No quotes
|AWS_REGION
|Region in which resources will be deployed
|No quaotes
|AWS_KEY_PAIR
|Generated in Step 2
|Only base name without .pem extension.
|CDP_ACCESS_KEY_ID
|Generated in CDP section of Step 1
|No quotes
|CDP_PRIVATE_KEY
|Generated in CDP section of Step 1
|No quotes
|WORKSHOP_NAME
|Name for the workshop. Will used to create resources.
|No quotes and underscore and should be between 5-18 characters
|NUMBER_OF_WORKSHOP_USERS
|Number of user ids need to be created for the workshop
|No quotes, only integer
|WORKSHOP_USER_PREFIX
|Prefix for creating workshop users in Keycloak
|No quotes, only string
|WORKSHOP_USER_DEFAULT_PASSWORD
|Default password for participants
|No quotes
|CDP_DEPLOYMENT_TYPE
|Cell in column 2, row 2
|Cell in column 3, row 2
|LOCAL_MACHINE_IP
|Cell in column 2, row 2
|Cell in column 3, row 2
|KEYCLOAK_SECURITY_GROUP_NAME
|Cell in column 2, row 2
|Cell in column 3, row 2


|===
---
